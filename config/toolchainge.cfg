[gcode_macro TOOLCHANGE]
description: Automatischer Filamentwechsel mit Pause, Entladen, Reinigen, Laden und Purge
gcode:
  # Pause den Druck
  PAUSE
  # Warte, bis der Druck pausiert ist
  RESPOND TYPE=command MSG="action:pause"

  # Parke den Druckkopf an einer sicheren Position
  _TOOLHEAD_PARK_PAUSE_CANCEL

  # Entlade das Filament mit dem Orbiter-Unload-Macro
  RESPOND TYPE=echo MSG="Entlade Filament..."
  ORBITER_UNLOAD

  # Reinige die Nozzle
  RESPOND TYPE=echo MSG="Reinige Nozzle..."
  CLEAN_NOZZLE

  # Warte auf Benutzerinteraktion, um neues Filament zu laden
  RESPOND TYPE=command MSG="action:prompt_begin Bitte neues Filament laden und bestätigen"
  RESPOND TYPE=command MSG="action:prompt_button Confirm|RESUME_TOOLCHANGE"
  RESPOND TYPE=command MSG="action:prompt_show"

[gcode_macro RESUME_TOOLCHANGE]
description: Fortsetzung des Filamentwechsels nach Benutzerinteraktion
gcode:
  # Lade das neue Filament mit dem Orbiter-Load-Macro
  RESPOND TYPE=echo MSG="Lade neues Filament..."
  ORBITER_LOAD

  # Purge 5-10mm Filament, um sicherzustellen, dass das neue Material fließt
  RESPOND TYPE=echo MSG="Purge neues Filament..."
  G91 ; Relativer Modus
  G1 E10 F300 ; Extrudiere 10mm Filament
  G90 ; Absoluter Modus

  # Reinige die Nozzle erneut
  RESPOND TYPE=echo MSG="Reinige Nozzle erneut..."
  CLEAN_NOZZLE

  # Setze den Druck fort
  RESPOND TYPE=echo MSG="Setze Druck fort..."
  RESUME