# This file contains common pin mappings for the Fysetc Spider board.
# To use this config, the firmware should be compiled for the STM32F446.
# When calling "menuconfig", enable "extra low-level configuration setup"
# and select the "12MHz crystal" as clock reference.
# For flashing, write the compiled klipper.bin to memory location 0x08000000

# See docs/Config_Reference.md for a description of parameters.

# -------------------------
# HW Informations
# ************************

#pi@vx-sagittarii ~> ~/klippy-env/bin/python ~/klipper/scripts/canbus_query.py can0
#/home/pi/klipper/scripts/canbus_query.py:49: DeprecationWarning: The 'bustype' argument is deprecated since python-can v4.2.0, and scheduled for removal in python-can v5.0.0. Use 'interface' instead.
#  bus = can.interface.Bus(
#[can0] Found canbus_uuid=667b9073d231, Application: Katapult, Unassigned
#Total 1 uuids found
#SocketcanBus was not properly shut down

#pi@vx-sagittarii ~> dmesg -HW
#[Jun27 21:21] usb 1-1.3: USB disconnect, device number 6
#[  +4.549986] usb 1-1.3: new full-speed USB device number 7 using dwc_otg
#[  +0.121007] usb 1-1.3: New USB device found, idVendor=1d50, idProduct=614e, bcdDevice= 1.00
#[  +0.000039] usb 1-1.3: New USB device strings: Mfr=1, Product=2, SerialNumber=3
#[  +0.000023] usb 1-1.3: Product: stm32f446xx
#[  +0.000014] usb 1-1.3: Manufacturer: Klipper
#[  +0.000013] usb 1-1.3: SerialNumber: 1A004A001550325635393320
#[  +0.004506] cdc_acm 1-1.3:1.0: ttyACM0: USB ACM device

# CAN Bus: Bigtreetech U2C V2.1
#pi@vx-sagittarii ~/printer_data (main)> dmesg -HW
#[Jun28 01:39] usb 1-1.5: new full-speed USB device number 5 using dwc_otg
#[  +0.091463] usb 1-1.5: New USB device found, idVendor=1d50, idProduct=606f, bcdDevice= 0.00
#[  +0.000037] usb 1-1.5: New USB device strings: Mfr=1, Product=2, SerialNumber=3
#[  +0.000015] usb 1-1.5: Product: budgetcan gs_usb
#[  +0.000016] usb 1-1.5: Manufacturer: budgetcan
#[  +0.000012] usb 1-1.5: SerialNumber: 003400085542500920303939
#[  +0.064668] CAN device driver interface
#[  +0.011247] gs_usb 1-1.5:1.0: Configuring for 1 interfaces
#[  +0.002615] usbcore: registered new interface driver gs_usb

# Sensor Pinconnections:
## Mainboard:
# PB0 = Chamber temp
# PB1 = Heat-Bead left out sensor
# PC3 = Heat-Bead main sensor
# PB2 = Fan2 = FAN mainboard
# PB? = Fan? = FAN Heat-Bead center
# PB? = Fan? = FAN Heat-Bead left+right
# Y-Endstop on Y endstop pin

#####################################################################
# Includes
#####################################################################
[include BTT_EBB36.cfg]
[include cartographer.cfg]
[include Orbiter2_SmartSensor.cfg]
[include mainsail.cfg]
[include input_shaper.cfg]
[include print_START.cfg]
#[include ellis_PAUSE_RESUME_CANCLE.cfg]
[include stealthburner_leds.cfg]
#[include adxl345_stm32f042.cfg]
# TODO: KAMP: https://github.com/kyleisah/Klipper-Adaptive-Meshing-Purging
# TODO: badfans for TheFilter: https://github.com/nateb16/VoronUsers/tree/master/printer_mods/nateb16/THE_FILTER
#[include bedfans.cfg]
[include TEST_SPEED.cfg]
[include utility_functions.cfg]
[include clean_Nozzle.cfg]
[include mainsail_user_macros.cfg]
[include print_END.cfg]
[include toolchainge.cfg]

#####################################################################
# Mainsail CFG
## Client variable macro for your printer.cfg
#####################################################################
[gcode_macro _CLIENT_VARIABLE]
variable_use_custom_pos   : True  ; use custom park coordinates for x,y [True/False]
variable_custom_park_x    : 62.0  ; custom x position; value must be within your defined min and max of X
variable_custom_park_y    : 357.0 ; custom y position; value must be within your defined min and max of Y
variable_custom_park_dz   : 2.0   ; custom dz value; the value in mm to lift the nozzle when move to park position
variable_retract          : 2.0   ; the value to retract while PAUSE
variable_cancel_retract   : 5.0   ; the value to retract while CANCEL_PRINT
variable_speed_retract    : 35.0  ; retract speed in mm/s
variable_unretract        : 1.8   ; the value to unretract while RESUME
variable_speed_unretract  : 35.0  ; unretract speed in mm/s
variable_speed_hop        : 15.0  ; z move speed in mm/s
variable_speed_move       : 100.0 ; move speed in mm/s
variable_park_at_cancel   : True  ; allow to move the toolhead to park while execute CANCEL_PRINT [True/False]
variable_park_at_cancel_x : 18    ; different park position during CANCEL_PRINT [None/Position as Float]; park_at_cancel must be True
variable_park_at_cancel_y : 350   ; different park position during CANCEL_PRINT [None/Position as Float]; park_at_cancel must be True
# !!! Caution [firmware_retraction] must be defined in the printer.cfg if you set use_fw_retract: True !!!
variable_use_fw_retract   : False ; use fw_retraction instead of the manual version [True/False]
variable_idle_timeout     : 0     ; time in sec until idle_timeout kicks in. Value 0 means that no value will be set or restored
								  ; If a sensor is defined, it will be used to cancel the execution of RESUME in case no filament is detected.
variable_runout_sensor    : "filament_switch_sensor O2_sensor"
#                                   Specify the config name of the runout sensor e.g "filament_switch_sensor runout". Hint use the same as in your printer.cfg
# !!! Custom macros, please use with care and review the section of the corresponding macro.
# These macros are for simple operations like setting a status LED. Please make sure your macro does not interfere with the basic macro functions.
# Only  single line commands are supported, please create a macro if you need more than one command.
variable_user_pause_macro : "_pre_pause"    ; Everything inside the "" will be executed after the klipper base pause (PAUSE_BASE) function
variable_user_resume_macro: ""    ; Everything inside the "" will be executed before the klipper base resume (RESUME_BASE) function
variable_user_cancel_macro: ""    ; Everything inside the "" will be executed before the klipper base cancel (CANCEL_PRINT_BASE) function
gcode:

#####################################################################
# Mainboard & Printer
#####################################################################

#[virtual_sdcard] is in mainsail.cfg
#path: ~/printer_data/gcodes
#on_error_gcode: CANCEL_PRINT

[mcu]
## Obtain definition by "ls -l /dev/serial/by-id/" then unplug to verify
serial: /dev/serial/by-id/usb-Klipper_stm32f446xx_1A004A001550325635393320-if00

[temperature_sensor SKR_Pro]
sensor_type: temperature_mcu
min_temp: 0
max_temp: 100

#[mcu rpi]
#serial: /tmp/klipper_host_mcu

[temperature_sensor raspberry_pi_3B]
sensor_type: temperature_host
min_temp: 10
max_temp: 100

[printer]
kinematics: corexy
max_velocity: 400
max_accel: 4800
max_z_velocity: 5
max_z_accel: 100

#####################################################################
# Steppers
#####################################################################

[stepper_x]
step_pin: PE11
dir_pin: PE10
enable_pin: !PE9
microsteps: 16
rotation_distance: 40
full_steps_per_rotation:200
endstop_pin: ^EBBCan: PB8 #^PB14  # PA1 for X-max
position_endstop: 350
position_min: 0
position_max: 350
homing_speed: 50
homing_retract_dist: 5
homing_positive_dir: true

[stepper_y]
step_pin: PD8
dir_pin: PB12
enable_pin: !PD9
microsteps: 16
rotation_distance: 40
endstop_pin: ^PB13  # PA2 for Y-max
position_endstop: 358 # Triggers @357.8!
position_min: 0
position_max: 358
homing_speed: 50
homing_retract_dist: 5
homing_positive_dir: true

## Z0 Stepper - Front Left - In Z-MOT Position
[stepper_z]
step_pin: PD14
dir_pin: PD13
enable_pin: !PD15
rotation_distance: 40
gear_ratio: 80:16
microsteps: 16
#endstop_pin: !PA0 #DD for Bed Z-Endstop not in use until auto_z_calibration is installed and setup
endstop_pin: probe:z_virtual_endstop #DD old was !PA0 #BB Cartographer uses this also
#position_endstop: 5 # cartographer needs this to be commented out
#my_coppied_in: position_endstop: 1.6695 #-0.5 #Cartographer: neads to be this removed
#	Uncomment below for 300mm build
position_max: 240
position_min: -5
homing_speed: 8
second_homing_speed: 3
homing_retract_dist: 0 #old: 3; Cartographer neads 0

[safe_z_home]
home_xy_position: 175,175
z_hop: 10


##	In E1-MOT Position
##	Z1 Stepper - Rear Left
[stepper_z1]
step_pin: PE6
dir_pin: !PC13
enable_pin: !PE5
rotation_distance: 40
gear_ratio: 80:16
microsteps: 16

##	In E2-MOT Position
##	Z2 Stepper - Rear Right
[stepper_z2]
step_pin: PE2
dir_pin: PE4
enable_pin: !PE3
rotation_distance: 40
gear_ratio: 80:16
microsteps: 16

##	In E3-MOT Position
##	Z3 Stepper - Front Right
[stepper_z3]
step_pin: PD12
dir_pin: !PC4
enable_pin: !PE8
rotation_distance: 40
gear_ratio: 80:16
microsteps: 16


[quad_gantry_level]
gantry_corners:
   -60,-10
   410,420
#  Probe points
points:
   50,25   # Point 1
   50,275  # Point 2
   300,275 # Point 3
   300,25  # Point 4
speed: 100
horizontal_move_z: 10
retries: 5
retry_tolerance: 0.0075
max_adjust: 10

#####################################################################
# Heated Bed
#####################################################################

[heater_bed]
heater_pin: PB4
sensor_type: EPCOS 100K B57560G104F
sensor_pin: PC3
#control: watermark
min_temp: 0
max_temp: 130

#####################################################################
# (only)Fans :)
#####################################################################

#fan for control board FAN2
[heater_fan controller_fan]
pin: PB2
kick_start_time: 0.5
heater: heater_bed
heater_temp: 45.0
fan_speed: 0.3

#####################################################################
# Temperature Sensors
#####################################################################
[temperature_sensor chamber]
sensor_type: ATC Semitec 104NT-4-R025H42G
sensor_pin:   PB0

#####################################################################
# LED Control
#####################################################################

#[output_pin caselight ]
##  Chamber Lighting - In 5V-RGB Position
#pin: PD3
#pwm: true
#shutdown_value: 0
#value:100
#cycle_time: 0.01


########################################
# TMC UART configuration
########################################

[tmc2209 stepper_x]
uart_pin: PE7
interpolate: True
run_current: 0.85
sense_resistor: 0.110
stealthchop_threshold: 0

[tmc2209 stepper_y]
uart_pin: PE15
interpolate: True
run_current: 0.85
sense_resistor: 0.110
stealthchop_threshold: 0

[tmc2209 stepper_z]
uart_pin: PD10
uart_address: 0
interpolate: True
run_current: 0.7
sense_resistor: 0.110
stealthchop_threshold: 0

[tmc2209 stepper_z1]
uart_pin: PC14
interpolate: True
run_current: 0.7
sense_resistor: 0.110
stealthchop_threshold: 0

[tmc2209 stepper_z2]
uart_pin: PC15
interpolate: true
run_current: 0.7
sense_resistor: 0.110
stealthchop_threshold: 0

[tmc2209 stepper_z3]
uart_pin: PA15
interpolate: true
run_current: 0.7
sense_resistor: 0.110
stealthchop_threshold: 0

########################################
# TMC SPI configuration
########################################

#[tmc2130 stepper_x]
#spi_bus: spi4
#cs_pin: PE7
#diag1_pin: PB14
#run_current: 0.800
#stealthchop_threshold: 999999

#[tmc2130 stepper_y]
#spi_bus: spi4
#cs_pin: PE15
#diag1_pin: PB13
#run_current: 0.800
#stealthchop_threshold: 999999

#[tmc2130 stepper_z]
#spi_bus: spi4
#cs_pin: PD10
#diag1_pin: PA0
#run_current: 0.800
#stealthchop_threshold: 999999

#[tmc2130 extruder]
#spi_bus: spi4
#cs_pin: PD7
#diag1_pin: PA3
#run_current: 0.800
#stealthchop_threshold: 999999

########################################
# EXP1 / EXP2 (display) pins
########################################

[board_pins]
aliases:
	# EXP2 header
	EXP1_10=<5V>, EXP1_9=<GND>,
	EXP1_8=PD1,   EXP1_7=PD0,
	EXP1_6=PC12,  EXP1_5=PC10,     # Slot in the socket on the other side
	EXP1_4=PD2,   EXP1_3=PC11,
	EXP1_2=PA8,   EXP1_1=PC9,

	# EXP1 header
	EXP2_10=<5V>, EXP2_9=<GND>,
	EXP2_8=<RST>, EXP2_7=PB10,
	EXP2_6=PA7,   EXP2_5=PC7,       # Slot in the socket on the other side
	EXP2_4=PA4,   EXP2_3=PC6,
	EXP2_2=PA5,   EXP2_1=PA6

# See the sample-lcd.cfg file for definitions of common LCD displays.

#*# <---------------------- SAVE_CONFIG ---------------------->
#*# DO NOT EDIT THIS BLOCK OR BELOW. The contents are auto-generated.
#*#
#*# [scanner]
#*# mode = touch
#*# scanner_touch_threshold = 2050
#*# scanner_touch_speed = 3
#*# scanner_touch_z_offset = 0.065
#*#
#*# [scanner model default]
#*# model_coef = 1.4657369013938395,
#*# 	1.7970427351161957,
#*# 	0.7390088295001528,
#*# 	0.3487073096431513,
#*# 	0.5372408079168157,
#*# 	0.45201867410095875,
#*# 	-0.46523899832988647,
#*# 	-0.4289107589248561,
#*# 	0.37334749447439425,
#*# 	0.28204555361114353
#*# model_domain = 3.170347961098897e-07,3.312081275577586e-07
#*# model_range = 0.200000,5.100000
#*# model_temp = 27.777676
#*# model_offset = 0.00000
#*# model_mode = touch
#*# model_fw_version = CARTOGRAPHER 5.1.0
#*#
#*# [bed_mesh default]
#*# version = 1
#*# points =
#*# 	0.122741, 0.106471, 0.086118, 0.079624, 0.079862, 0.066731, 0.046981, 0.032905, 0.027988, 0.027347, 0.031990, 0.045503, 0.055317, 0.059994, 0.068712, 0.087421, 0.111697, 0.132361, 0.140228, 0.139115, 0.131712, 0.126164, 0.123984, 0.126713, 0.136003
#*# 	0.116884, 0.094488, 0.073151, 0.060332, 0.051428, 0.040374, 0.029014, 0.024174, 0.021598, 0.022296, 0.027726, 0.040124, 0.047946, 0.055339, 0.064439, 0.082962, 0.103093, 0.122778, 0.137907, 0.141027, 0.133646, 0.126717, 0.126688, 0.134305, 0.143311
#*# 	0.130291, 0.102190, 0.078269, 0.060228, 0.047028, 0.037040, 0.028197, 0.022231, 0.017339, 0.016191, 0.021006, 0.029905, 0.039253, 0.045876, 0.053390, 0.068782, 0.086593, 0.100994, 0.120075, 0.127470, 0.123005, 0.115276, 0.114979, 0.119962, 0.133444
#*# 	0.113956, 0.089561, 0.066281, 0.048707, 0.037111, 0.026445, 0.019860, 0.016188, 0.013236, 0.013132, 0.019219, 0.029177, 0.037093, 0.045405, 0.055050, 0.072856, 0.088026, 0.103753, 0.116404, 0.123081, 0.122868, 0.121254, 0.123024, 0.131627, 0.147661
#*# 	0.129662, 0.099363, 0.075006, 0.055082, 0.040149, 0.028820, 0.018055, 0.013190, 0.011020, 0.010804, 0.014531, 0.023431, 0.031933, 0.037166, 0.044926, 0.059703, 0.073671, 0.087058, 0.099669, 0.106407, 0.108942, 0.109113, 0.110868, 0.121145, 0.137761
#*# 	0.108985, 0.079566, 0.055849, 0.036083, 0.023765, 0.014201, 0.003969, 0.001616, -0.000281, -0.000124, 0.006446, 0.017245, 0.024882, 0.028674, 0.036661, 0.052595, 0.068756, 0.084512, 0.096716, 0.103549, 0.101891, 0.101757, 0.111190, 0.126209, 0.145181
#*# 	0.120538, 0.087951, 0.059928, 0.038471, 0.024676, 0.012664, 0.004578, 0.000514, -0.002319, -0.005236, -0.000524, 0.007795, 0.015324, 0.019776, 0.024964, 0.038146, 0.052907, 0.069102, 0.083751, 0.092302, 0.088936, 0.090006, 0.102104, 0.120015, 0.138293
#*# 	0.107336, 0.073408, 0.046861, 0.026312, 0.014013, 0.003148, -0.004734, -0.009085, -0.010021, -0.011241, -0.006979, 0.000741, 0.008149, 0.013785, 0.021794, 0.035499, 0.049623, 0.065544, 0.079337, 0.085933, 0.088240, 0.095328, 0.112854, 0.133310, 0.156509
#*# 	0.111405, 0.078094, 0.048843, 0.026901, 0.013290, 0.003261, -0.006249, -0.012644, -0.017723, -0.019859, -0.018150, -0.010417, -0.003772, 0.001065, 0.006295, 0.018168, 0.031209, 0.043829, 0.058130, 0.067069, 0.071357, 0.079660, 0.097248, 0.120570, 0.143737
#*# 	0.099194, 0.064696, 0.037921, 0.017917, 0.005296, -0.005205, -0.014667, -0.020848, -0.022944, -0.022674, -0.017469, -0.013626, -0.006089, -0.002478, 0.006393, 0.017459, 0.031507, 0.044069, 0.054894, 0.065424, 0.072858, 0.083372, 0.105472, 0.131983, 0.154150
#*# 	0.103629, 0.071217, 0.043725, 0.023158, 0.014652, 0.004403, -0.012284, -0.021466, -0.021588, -0.020205, -0.019488, -0.015706, -0.008182, -0.005387, -0.001236, 0.009706, 0.021910, 0.032014, 0.045268, 0.058449, 0.065526, 0.072238, 0.089347, 0.113029, 0.136628
#*# 	0.093576, 0.064126, 0.039875, 0.027052, 0.013792, -0.001948, -0.013349, -0.017847, -0.017024, -0.016282, -0.016912, -0.009764, -0.004308, 0.001045, 0.008502, 0.016846, 0.028613, 0.037144, 0.050077, 0.060535, 0.069472, 0.074682, 0.089565, 0.114206, 0.140951
#*# 	0.097675, 0.071660, 0.051983, 0.040347, 0.026785, 0.008760, -0.006775, -0.010208, -0.010970, -0.013929, -0.016235, -0.008374, -0.001457, 0.002906, 0.007113, 0.016811, 0.026476, 0.033120, 0.042382, 0.054827, 0.067189, 0.071893, 0.079301, 0.096514, 0.121868
#*# 	0.092783, 0.064528, 0.047872, 0.035208, 0.021423, 0.008203, -0.005929, -0.011976, -0.011724, -0.011936, -0.011606, -0.002908, 0.006452, 0.008991, 0.014081, 0.023583, 0.036589, 0.045685, 0.055214, 0.064013, 0.072176, 0.078377, 0.088619, 0.110791, 0.139048
#*# 	0.096517, 0.070132, 0.047179, 0.030528, 0.018819, 0.009374, -0.003561, -0.012341, -0.015916, -0.014773, -0.014567, -0.008731, 0.000314, 0.006832, 0.009689, 0.018093, 0.035109, 0.046281, 0.054513, 0.062008, 0.070163, 0.075609, 0.086089, 0.103892, 0.125911
#*# 	0.087553, 0.056117, 0.033094, 0.014041, 0.003274, -0.006396, -0.020317, -0.025793, -0.024551, -0.026257, -0.021992, -0.014000, -0.005779, -0.000638, 0.005661, 0.017991, 0.034279, 0.047040, 0.054153, 0.060597, 0.067729, 0.078586, 0.093683, 0.117169, 0.140928
#*# 	0.085548, 0.062670, 0.034454, 0.012719, -0.000683, -0.012376, -0.024874, -0.031946, -0.030880, -0.029518, -0.025487, -0.016740, -0.008089, -0.002594, 0.002116, 0.017706, 0.038170, 0.050256, 0.056331, 0.058534, 0.064114, 0.071688, 0.084035, 0.100909, 0.124707
#*# 	0.085319, 0.054503, 0.029395, 0.008528, -0.004283, -0.017549, -0.028817, -0.032559, -0.030054, -0.025106, -0.018356, -0.012186, -0.001476, 0.005975, 0.015863, 0.038070, 0.063600, 0.075611, 0.072143, 0.072271, 0.076861, 0.083939, 0.096163, 0.122246, 0.142079
#*# 	0.096857, 0.073585, 0.046596, 0.025249, 0.008050, -0.005590, -0.018892, -0.021049, -0.018759, -0.016537, -0.010382, -0.001044, 0.008317, 0.015389, 0.025129, 0.046123, 0.075115, 0.089299, 0.087485, 0.082741, 0.084407, 0.088839, 0.098684, 0.112597, 0.131144
#*# 	0.096424, 0.067014, 0.046020, 0.025791, 0.005932, -0.010173, -0.017720, -0.019292, -0.017212, -0.013702, -0.004271, 0.009520, 0.018261, 0.024228, 0.036572, 0.061255, 0.087054, 0.099095, 0.095241, 0.094428, 0.096800, 0.100647, 0.106321, 0.123017, 0.140255
#*# 	0.096060, 0.075262, 0.049716, 0.027823, 0.010168, -0.003968, -0.014079, -0.016285, -0.013529, -0.009303, -0.003064, 0.010628, 0.020950, 0.029085, 0.040190, 0.059782, 0.082093, 0.093573, 0.095860, 0.094618, 0.096056, 0.097554, 0.100380, 0.109460, 0.121561
#*# 	0.094889, 0.066269, 0.041722, 0.022955, 0.009909, -0.002827, -0.013202, -0.011977, -0.010095, -0.001651, 0.011199, 0.024451, 0.036803, 0.045937, 0.056718, 0.077299, 0.096860, 0.107618, 0.108882, 0.106821, 0.106141, 0.105196, 0.110559, 0.119871, 0.129730
#*# 	0.109174, 0.086146, 0.059997, 0.040433, 0.025864, 0.014145, 0.002306, 0.002064, 0.004733, 0.010447, 0.025425, 0.038475, 0.052036, 0.060615, 0.073730, 0.090490, 0.109761, 0.124547, 0.126682, 0.120728, 0.114230, 0.113108, 0.117907, 0.121554, 0.135022
#*# 	0.106821, 0.076133, 0.055061, 0.039620, 0.026279, 0.016273, 0.007232, 0.006633, 0.010937, 0.017689, 0.029906, 0.050279, 0.066850, 0.079688, 0.090548, 0.108925, 0.126284, 0.138231, 0.140088, 0.135115, 0.129484, 0.125033, 0.124419, 0.126609, 0.128310
#*# 	0.116647, 0.093110, 0.066018, 0.047733, 0.036163, 0.028416, 0.021826, 0.017982, 0.020966, 0.026190, 0.035688, 0.055136, 0.074975, 0.090449, 0.101122, 0.117743, 0.135750, 0.148383, 0.150223, 0.147996, 0.140490, 0.131500, 0.124801, 0.129989, 0.127705
#*# x_count = 25
#*# y_count = 25
#*# mesh_x_pps = 2
#*# mesh_y_pps = 2
#*# algo = bicubic
#*# tension = 0.2
#*# min_x = 50.0
#*# max_x = 310.0
#*# min_y = 25.0
#*# max_y = 290.0
#*#
#*# [heater_bed]
#*# pid_version = 1
#*# pid_target = 80.00
#*# pid_tolerance = 0.0200
#*# control = pid
#*# pid_kp = 24.296
#*# pid_ki = 0.748
#*# pid_kd = 197.405
